<package name="apache" version="&apache-version;">

    <packageinfo>
                <requires><name>db</name></requires>
                <requires><name>gdbm</name></requires>
                <requires><name>openssl</name></requires>
                <requires><name>openldap</name></requires>
                <requires><name>lynx</name></requires>
    </packageinfo>


    <stage name="Unpacking a package.">
	<unpack>
		<archive>&packages_dir;/&apache-package;</archive>
		<destination>&build_dir;</destination>
	</unpack>
	<copy>
	        <source>&packages_dir;/&apache-patch;</source>
	        <destination>&build_dir;</destination>
	</copy>
    </stage>

    <stage name="Installing a package.">
        <stageinfo>
		<base>&build_dir;/&apache-directory;</base>
	</stageinfo>

	<execute command="id -u apache &amp;> /dev/null || groupadd apache" />
	<execute command="id -u apache &amp;> /dev/null || useradd -c apache -d /dev/null -g apache -s /bin/false apache" />


	<patch>
		<param>-N</param>
		<param>-p1</param>
		<param>-i ../&apache-patch;</param>
	</patch>

	<configure>
                <param>--enable-layout=LFS</param>
                <param>--enable-mods-shared=all</param>
	</configure>

	<make />

	<make>
		<param>install</param>
	</make>


	<ownership user="root" group="root">
	        <name>/usr/sbin/apxs</name>
		<name>/usr/sbin/apachectl</name>
		<name>/usr/sbin/dbmmanage</name>
		<name>/usr/sbin/envvars-std</name>
		<name>/usr/sbin/envvars</name>
	</ownership>

	<ownership user="root" group="root">
	        <option>recursive</option>
		<name>/usr/include/apache/</name>
		<name>/usr/lib/apache/</name>
		<name>/var/www/</name>
		<name>/usr/share/man</name>
		<name>/usr/sbin/</name>
		<name>/usr/sbin/</name>
	</ownership>
		
	<search_replace
	    base = "/etc/apache">
	        <file>httpd.conf</file>
		<find>User nobody</find>
		<replace>User apache</replace>
	</search_replace>

	<search_replace
	    base = "/etc/apache">
	        <file>httpd.conf</file>
		<find>Group #-1</find>
		<replace>Group apache</replace>
	</search_replace>

	

	<textdump base="/etc/rc.d/init.d">
		<file>apache</file>
	<content>
	=#!/bin/bash
	=
	=source /etc/sysconfig/rc
	=source $rc_functions
	=
	=case "$1" in
	=        start)
	=                echo "Starting Apache daemon..."
	=                /usr/sbin/apachectl -k start
	=                evaluate_retval
	=                ;;
	=
	=        stop)
	=                echo "Stopping Apache daemon..."
	=                /usr/sbin/apachectl -k stop
	=                evaluate_retval
	=                ;;
	=
	=        restart)
	=                echo "Restarting Apache daemon..."
	=                /usr/sbin/apachectl -k restart
	=                evaluate_retval
	=                ;;
	=
	=        status)
	=                statusproc /usr/sbin/httpd
	=                ;;
	=                
	=        *)
	=                echo "Usage: $0 {start|stop|restart|status}"
	=                exit 1
	=                ;;
	=esac
	</content>
	</textdump>

	<permissions mode="755">
		<name>/etc/rc.d/init.d/apache</name>
	</permissions>
		
	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc0.d/K28apache</name>
	</link>

	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc1.d/K28apache</name>
	</link>

	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc2.d/K28apache</name>
	</link>

	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc3.d/S32apache</name>
	</link>

	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc4.d/S32apache</name>
	</link>

	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc5.d/S32apache</name>
	</link>

	<link base="/etc/rc.d/init.d">
	        <option>force</option>
		<target>../init.d/apache</target>
		<name>../rc6.d/K28apache</name>
	</link>
		

    </stage>

    <stage name="Clean-up.">
	<remove>&build_dir;/&apache-directory;</remove>
    </stage>

</package>
