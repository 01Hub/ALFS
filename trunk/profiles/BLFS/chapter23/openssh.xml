<package name="openssh" version="&openssh-version;">

        <packageinfo>
                <requires><name>openssl</name></requires>
		<utilizes><name>linuxpam</name></utilizes>
        </packageinfo>

	<stage name="Unpacking a package.">
		<unpack>
			<archive>&packages_dir;/&openssh-package;</archive>
			<destination>&build_dir;</destination>
		</unpack>
	</stage>

	<stage name="Installing a package.">
		<stageinfo>
			<base>&build_dir;/&openssh-directory;</base>
		</stageinfo>

		<mkdir>
		        <option>parents</option>
			<name>/var/empty</name>
		</mkdir>

		<ownership user="root" group="sys">
		        <name>/var/empty</name>
                </ownership>

		<execute command="grep sshd:  /etc/group  || groupadd">
		        <param>sshd</param>
		</execute>
		
		<execute command="id -u sshd || useradd">
			<param>-g sshd</param>
			<param>sshd</param>
		</execute>

		<configure>
		        <param>--prefix=/usr</param>
		        <param>--sysconfdir=/etc/ssh</param>
		        <param>--libexecdir=/usr/sbin</param>
		        <param>--with-md5-passwords</param>
		</configure>

		<make />

		<make>
		        <param>install</param>
		</make>
	</stage>

	<stage name="Configuring a package.">

      <textdump base="/etc/rc.d/init.d/">
	<file>sshd</file>
        <content>
	=#!/bin/sh
	=# Begin $rc_base/init.d/sshd
	=
	=# Based on sysklogd script from LFS-3.1 and earlier.
	=# Rewritten by Gerard Beekmans  - gerard@linuxfromscratch.org
	=
	=source /etc/sysconfig/rc
	=source $rc_functions
	=
	=case "$1" in
	=        start)
	=	        echo "Starting SSH Server..."
	=	        loadproc /usr/sbin/sshd
	=	        ;;
	=
	=	stop)
	=	        echo "Stopping SSH Server..."
	=	        killproc /usr/sbin/sshd
	=	        ;;
	=
	=	reload)
	=	        echo "Reloading SSH Server..."
	=	        reloadproc /usr/sbin/sshd
	=	        ;;
	=	     
	=	restart)
	=	        $0 stop
	=	        sleep 1
	=	        $0 start
	=	        ;;
	=
	=	status)
	=	        statusproc /usr/sbin/sshd
	=	        ;;
	=
	=	*)
	=	        echo "Usage: $0 {start|stop|reload|restart|status}"
	=	        exit 1
	=	        ;;
	=esac
	=
	=# End $rc_base/init.d/sshd
	</content>
	</textdump>

      <permissions mode="755" base="/etc/rc.d/init.d">
	<name>sshd</name>
      </permissions>


      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc0.d/K30sshd</name>
      </link>

      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc1.d/K30sshd</name>
      </link>

      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc2.d/K30sshd</name>
      </link>

      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc3.d/S30sshd</name>
      </link>

      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc4.d/S30sshd</name>
      </link>

      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc5.d/S30sshd</name>
      </link>

      <link base="/etc/rc.d/init.d">
	<option>force</option>
	<target>../init.d/sshd</target>
	<name>../rc6.d/K30sshd</name>
      </link>

      </stage>

	<stage name="Clean-up.">
		<remove>&build_dir;/&openssh-directory;</remove>
	</stage>

</package>
