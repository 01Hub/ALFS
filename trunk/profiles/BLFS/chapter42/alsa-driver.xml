<package name="alsa-driver" version="&alsa-driver-version;">

	<stage name="Unpacking a package.">
		<unpack>
			<archive>&packages_dir;/&alsa-driver-package;</archive>
			<destination>&build_dir;</destination>
		</unpack>
	</stage>

	<stage name="Installing a package.">
		<stageinfo>
			<base>&build_dir;/&alsa-driver-directory;</base>
		</stageinfo>

		<remove>&build_dir;/&alsa-driver-directory;/include/linux/isapnp.h</remove>

		<configure>
		        <param>--with-moddir=/lib/modules/&kernel-version;/kernel/drivers/sound/</param>
			<param>--with-kernel=&kernel-directory;</param>
			<param>--with-sequencer=yes</param>
			<param>--with-oss=yes</param>
			<param>--with-isapnp=no</param> 
			<param>--with-cards=&sound-card;</param>
		</configure>

		<make/>
		
		<make>
			<param>install</param>
		</make>

		<execute command="./snddevices" />

		<textdump base="/etc" mode="append">
		        <file>modules.conf</file>
			
		        <content>
			        =alias char-major-14 soundcore
				=alias char-major-116 snd
				=
				=alias snd-card-0 snd-&sound-card;
				=
				=alias sound-slot-0 snd-card-0
				=
				=alias sound-service-0-0 snd-mixer-oss
				=alias sound-service-0-1 snd-seq-oss
				=alias sound-service-0-3 snd-pcm-oss
				=alias sound-service-0-8 snd-seq-midi
			</content>
		</textdump>

		<execute command="/sbin/depmod" />

		<textdump base="/etc/rc.d/init.d">
		        <file>alsa</file>
			
			<content>
			        =#!/bin/sh
				=# Begin $rc_base/init.d/alsa
				=
				=# Based on sysklogd script from LFS-3.1 and earlier.
				=# Rewritten by Gerard Beekmans  - gerard@linuxfromscratch.org
				=# ALSA specific parts by Mark Hymers - markh@linuxfromscratch.org
				=# Stores mixer settings in the default location: /etc/asound.state
				=
				=source /etc/sysconfig/rc
				=source $rc_functions
				=
				=case "$1" in
				=    start)
				=        echo -n "Starting alsa...    Restoring volumes..."
				=        loadproc /usr/sbin/alsactl restore
				=        #echo -n "                    Loading MIDI font..."
				=        #loadproc sfxload /path/to/soundfont
				=        ;;
				=
				=    stop)
				=        echo -n "Stopping alsa...    Saving volumes......"
				=        loadproc /usr/sbin/alsactl store
				=        #echo -n "            Removing MIDI font.........."
				=        #loadproc sfxload -i
				=        ;;
				=
				=    restart)
				=        $0 stop
				=        /usr/bin/sleep 1
				=        $0 start
				=        ;;
				=
				=    *)
				=        echo "Usage: $0 {start|stop|restart}"
				=        exit 1
				=        ;;
				=
				=esac
			</content>
		</textdump>
			
		<permissions mode="755">
		        <name>/etc/rc.d/init.d/alsa</name>
		</permissions>

		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc0.d/K35alsa</name>
		</link>

		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc1.d/K35alsa</name>
		</link>


		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc2.d/S40alsa</name>
		</link>


		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc3.d/S40alsa</name>
		</link>


		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc4.d/S40alsa</name>
		</link>


		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc5.d/S40alsa</name>
		</link>


		<link base="/etc/rc.d/init.d">
		        <option>force</option>
		        <target>../init.d/alsa</target>
			<name>../rc6.d/K35alsa</name>
		</link>

	</stage>

	<stage name="Clean-up.">
		<remove>&build_dir;/&alsa-driver-directory;</remove>
	</stage>

</package>
