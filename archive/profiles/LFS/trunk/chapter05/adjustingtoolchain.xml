<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE alfs SYSTEM "../DTD/ALFS.dtd"
[
<!ENTITY % general_entities SYSTEM "../config/general.ent">
<!ENTITY % package_entities SYSTEM "../config/package.ent">

%general_entities;
%package_entities;
]>
<alfs>
  <stage name="Adjusting the Toolchain">
    <stageinfo>
      <base>&build_dir;</base>
    </stageinfo>
    <move>
      <source>/tools/bin/ld</source>
      <destination>/tools/bin/ld-old</destination>
    </move>
    <move>
      <source>/tools/$(gcc -dumpmachine)/bin/ld</source>
      <destination>/tools/$(gcc -dumpmachine/bin/ld-old</destination>
    </move>
    <move>
      <source>/tools/bin/ld-new</source>
      <destination>/tools/bin/ld</destination>
    </move>
    <link>
      <option>force</option>
      <target>/tools/bin/ld</target>
      <name>/tools/$(gcc -dumpmachine)/bin/ld</name>
    </link>
    <execute command="gcc"> 
      <param>-dumpspecs &gt; </param>
      <param>`dirname $(gcc -print-libgcc-file-name)`/specs</param>
      </execute>
      <execute command="sed">
        <param>'s@^/lib/ld-linux.so.2@/tools&real-amp;@g'</param>
        <param>`dirname $(gcc -print-libgcc-file-name)`/specs &gt; tempspecfile </param>
      </execute>
      <move>
	<option>force</option>
	<source>tempspecfile</source>
	<destination>`dirname $(gcc -print-libgcc-file-name)`/specs</destination>
      </move>
      <execute command="find">
        <param>`dirname $(gcc -print-libgcc-file-name)`/include/*</param>
        <param>-maxdepth 0 -xtype d -exec rm -rf '{}' \;</param>
      </execute>
      <execute command="rm">
        <param>-f</param> 
        <param>`grep -l 'DO NOT EDIT THIS FILE'</param>
        <param>$(dirname $(gcc -print-libgcc-file-name))/include/*`</param>
      </execute>

    <!-- Test basic functions of toolchain with:
        echo 'main(){}' > dummy.c; gcc dummy.c; readelf -l a.out | grep ': /tools';
Output of last line s/b: [Requesting program interpreter: /tools/lib/ld-linux.so.2]
If so:  
        rm dummy.c a.out
Otherwise, STOP HERE & find & fix the problem
-->
  </stage>
</alfs>
